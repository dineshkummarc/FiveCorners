<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<title>FiveCorners</title>
		<script type="text/javascript" src="jquery.js"></script>
		<script type="text/javascript">

		$(document).ready(function(){

			if (navigator.geolocation){
				navigator.geolocation.getCurrentPosition(
				
					function (position) {  

						$('body').append('<p>Position: ' +  position.coords.latitude + ' ' + position.coords.longitude + '</p>');
			 
						var url = 'ajax.php?action=venues&geolat=' + position.coords.latitude + '&geolong=' + position.coords.longitude;

						
						$.ajax({
							url: url, 
							dataType: 'json',
							success: function(data, textStatus, XMLHttpRequest){
									
									//alert(XMLHttpRequest.status + '\n' + XMLHttpRequest.responseText);
									
									var ul = document.createElement('ul');
									ul.id = 'venues';
									var $ul = $(ul);
							
									var venues = data.groups[0].venues;
							
									var v = venues.length;
									for(i = 0; i<v; i++){
										var venue = venues[i];
										$ul.append('<li><h3>' + venue.name + '</h3><p>' + venue.address + ', ' + venue.city + '</p></li><a href="ajax.php?action=checkin&amp;vid=' + venue.id + '" class="checkin">checkin</a>');
									}
				
									$('body').append($ul);
								
								},
							error: function(XMLHttpRequest, textStatus, errorThrown){

									if(XMLHttpRequest.status == 401){

										$('body').append('<p><a href="' + XMLHttpRequest.responseText + '">Login Via Foursquare</a></p>');

									}
									else{
										alert(XMLHttpRequest.status + '\n' + XMLHttpRequest.responseText);
									}
				
								}
				
						});
						
					},
					// next function is the error callback
					function (error) {
						switch(error.code) {
							case error.TIMEOUT:
								alert ('Timeout');
								break;
							case error.POSITION_UNAVAILABLE:
								alert ('Position unavailable');
								break;
							case error.PERMISSION_DENIED:
								alert ('Permission denied');
								break;
							case error.UNKNOWN_ERROR:
								alert ('Unknown error');
								break;
						}
					}
				);
			}
			
			$('a.checkin').live('click', function(){
			
					$.ajax({
						url: this.href, 
						dataType: 'json',
						success: function(data, textStatus, XMLHttpRequest){
								
								this.parent('li').addClass('checked-in');
								alert(data.checkin.message);
								if(data.badges.length>0){
									alert('Badge:' + data.badges.badge.name + '\n' + data.badges.badge.description);
								}
							
							},
						error: function(XMLHttpRequest, textStatus, errorThrown){

								if(XMLHttpRequest.status == 401){

									$('ul').remove();
									$('body').append('<p><a href="' + XMLHttpRequest.responseText + '">Login Via Foursquare</a></p>');

								}
								else{
									alert(XMLHttpRequest.status + '\n' + XMLHttpRequest.responseText);
								}
			
							}
			
					});
					
					return false;
					
			});

		});

		</script>
	</head>
	<body>
		<h1>Five Corners</h1>
	</body>
</html>
