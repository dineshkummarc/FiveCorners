<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<title>FiveCorners</title>
		<meta name="viewport" content="width=device-width" />
		<script type="text/javascript" src="jquery.js"></script>
		<script type="text/javascript">

		$(document).ready(function(){

			if (navigator.geolocation){
				navigator.geolocation.getCurrentPosition(
				
					function (position) {  

						$('#app-content').append('<p>Position: ' +  position.coords.latitude + ' ' + position.coords.longitude + '</p>');
			 			
			 			$('#app-content').attr('data-geolat', position.coords.latitude);
			 			$('#app-content').attr('data-geolong', position.coords.longitude);
			 			
						var url = 'ajax.php?action=venues&geolat=' + position.coords.latitude + '&geolong=' + position.coords.longitude;

						
						$.ajax({
							url: url, 
							dataType: 'json',
							success: function(data, textStatus, XMLHttpRequest){
									
									//alert(XMLHttpRequest.status + '\n' + XMLHttpRequest.responseText);
									
									var ul = document.createElement('ul');
									ul.id = 'venues';
									var $ul = $(ul);
							
									var venues = data.groups[0].venues;
							
									var v = venues.length;
									for(i = 0; i<v; i++){
										var venue = venues[i];
										$ul.append('<li><h3>' + venue.name + '</h3><p>' + venue.address + ', ' + venue.city + '</p><nav><a href="ajax.php?action=checkin&amp;vid=' + venue.id + '" class="checkin">checkin</a></nav></li>');
									}
				
									$('#app-content').append($ul);
								
								},
							error: function(XMLHttpRequest, textStatus, errorThrown){

									if(XMLHttpRequest.status == 401){

										$('#app-content').append('<p class="login"><a href="' + XMLHttpRequest.responseText + '">Login Via Foursquare</a></p>');

									}
									else{
										alert(XMLHttpRequest.status + '\n' + XMLHttpRequest.responseText);
									}
				
								}
				
						});
						
					},
					// next function is the error callback
					function (error) {
						switch(error.code) {
							case error.TIMEOUT:
								alert ('Timeout');
								break;
							case error.POSITION_UNAVAILABLE:
								alert ('Position unavailable');
								break;
							case error.PERMISSION_DENIED:
								alert ('Permission denied');
								break;
							case error.UNKNOWN_ERROR:
								alert ('Unknown error');
								break;
						}
					}
				);
			}
			
			$('a.checkin').live('click', function(){
			
					$.ajax({
						url: this.href, 
						dataType: 'json',
						success: function(data, textStatus, XMLHttpRequest){
								
								$(this).parent('li').addClass('checked-in');
								alert(data.checkin.message);
								if(data.badges.length>0){
									alert('Badge:' + data.badges.badge.name + '\n' + data.badges.badge.description);
								}
							
							},
						error: function(XMLHttpRequest, textStatus, errorThrown){

								if(XMLHttpRequest.status == 401){

									$('#app-content ul').remove();
									$('#app-content ').append('<p><a href="' + XMLHttpRequest.responseText + '">Login Via Foursquare</a></p>');

								}
								else{
									alert(XMLHttpRequest.status + '\n' + XMLHttpRequest.responseText);
								}
			
							}
			
					});
					
					return false;
					
			});

			$('header nav a').live('click', function(){

				var url = this.href + '&geolat=' + $('#app-content').data('geolat') + '&geolong=' + $('#app-content').data('geolong');

				$.ajax({
					url: url, 
					dataType: 'json',
					success: function(data, textStatus, XMLHttpRequest){
							
							//alert(XMLHttpRequest.status + '\n' + XMLHttpRequest.responseText);
							
							var ul = document.createElement('ul');
							ul.id = 'venues';
							var $ul = $(ul);
					
							var venues = data.groups[0].venues;
					
							var v = venues.length;
							for(i = 0; i<v; i++){
								var venue = venues[i];
								$ul.append('<li><h3>' + venue.name + '</h3><p>' + venue.address + ', ' + venue.city + '</p><nav><a href="ajax.php?action=checkin&amp;vid=' + venue.id + '" class="checkin">checkin</a></nav></li>');
							}
		
							$('#app-content').append($ul);
						
						},
					error: function(XMLHttpRequest, textStatus, errorThrown){

							if(XMLHttpRequest.status == 401){

								$('#app-content').append('<p class="login"><a href="' + XMLHttpRequest.responseText + '">Login Via Foursquare</a></p>');

							}
							else{
								alert(XMLHttpRequest.status + '\n' + XMLHttpRequest.responseText);
							}
		
						}
		
				});
				
				return false;
				
			});

		});

		</script>
		<style>
			body {
				margin: 0;
				padding: 0;
				background: #fff;
				color: #333;
				font-size: 14px;
				font-family: "Gil Sans", "Helvetika", sans-serif;
				text-align: left;
			}
			
			header {
				display: block;
				padding: 10px 20px;
				background: #0CBADF;
				color: #fff;
			}
			h1 {
				font-size: 20px;
				text-align: left;
			}
			nav {
				display: block;
				float: right;
				margin-top: -38px;
			}
			nav a {
				display: inline-block;
				padding: 3px 5px;
				border: 1px solid #1B6CB5;
				border-radius: 3px;
				background: #fff;
				color: #1B6CB5;
			}
			#app-content {
				padding: 20px;
			}
			#app-content ul {
				list-style-type: none;
				padding: 0;
				margin:0;
			}
			#app-content ul li {
				padding: 5px 0px;
				margin:5px 0px;
				border-top: 1px solid #ccc;
			}
			#app-content ul li.checked-in {
				background: #0CBADF;
				color: #fff;
			}
			h3 {
				font-size: 18px;
				margin:0;
			}
			p {
				margin:0;
			}
			a.checkin {
				display: inline-block;
				padding: 3px 5px;
				border: 1px solid #1B6CB5;
				border-radius: 3px;
				background: #fff;
				color: #1B6CB5;
			}
		</style>
	</head>
	<body>
		<header>
			<h1>Five Corners</h1>
			<nav>
				<a href="ajax.php?action=venues">refresh</a>
			</nav>
		</header>
		<section id="app-content">
		</section>
	</body>
</html>
